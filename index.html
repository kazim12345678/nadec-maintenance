<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Maintenance KPI Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --green:#1f8f4a;
  --blue:#0b5ed7;
  --bg:#f4f6f8;
  --card:#ffffff;
  --text:#1f2937;
}
body{
  margin:0;
  font-family:Arial, Helvetica, sans-serif;
  background:var(--bg);
  color:var(--text);
}
header{
  background:linear-gradient(90deg,var(--green),var(--blue));
  color:#fff;
  padding:15px;
}
h1{margin:0;font-size:22px}
section{padding:15px}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:15px;
}
.card{
  background:var(--card);
  padding:15px;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
}
.card h3{margin:0;font-size:14px;color:#555}
.card p{margin:5px 0 0;font-size:24px;font-weight:bold;color:var(--green)}
table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
}
th,td{
  border:1px solid #ddd;
  padding:6px;
  font-size:12px;
}
th{
  background:#e6f4ea;
}
input,select{
  width:100%;
  padding:4px;
  font-size:12px;
}
canvas{
  width:100%;
  height:250px;
}
.filter{
  display:flex;
  gap:10px;
  margin-bottom:10px;
}
footer{
  text-align:center;
  padding:10px;
  font-size:12px;
  color:#777;
}
</style>
</head>

<body>

<header>
  <h1>üè≠ Maintenance KPI Dashboard ‚Äì 18 Serac Lines</h1>
</header>

<section>
  <div class="grid">
    <div class="card"><h3>Total Breakdown Hours</h3><p id="kpiBreakdown">0</p></div>
    <div class="card"><h3>PM Completion %</h3><p id="kpiPM">0%</p></div>
    <div class="card"><h3>MTTR (hrs)</h3><p id="kpiMTTR">0</p></div>
    <div class="card"><h3>MTBF (hrs)</h3><p id="kpiMTBF">0</p></div>
    <div class="card"><h3>Maintenance Cost</h3><p id="kpiCost">0 SAR</p></div>
    <div class="card"><h3>Power Cost</h3><p id="kpiPower">0 SAR</p></div>
  </div>
</section>

<section>
<h2>RAW DATA (Editable)</h2>

<div class="filter">
  <label>Month:
    <input type="month" id="monthFilter">
  </label>
  <button onclick="recalculate()">Apply</button>
</div>

<table id="rawTable">
<thead>
<tr>
  <th>Date</th>
  <th>Line</th>
  <th>Machine</th>
  <th>Type</th>
  <th>Duration (hrs)</th>
  <th>Cost</th>
</tr>
</thead>
<tbody></tbody>
</table>

<button onclick="addRow()">‚ûï Add Row</button>
</section>

<section>
<h2>DASHBOARD</h2>
<canvas id="lineChart"></canvas>
</section>

<footer>
Maintenance Dashboard | LocalStorage Enabled | No Backend
</footer>

<script>
/* ------------------ DATA ------------------ */
let data = JSON.parse(localStorage.getItem("maintenanceData")) || [
  {date:"2025-01-05",line:1,machine:"Filler",type:"Breakdown",duration:2,cost:500},
  {date:"2025-01-08",line:2,machine:"Packer",type:"PM",duration:1,cost:200},
  {date:"2025-01-12",line:1,machine:"Labeler",type:"Breakdown",duration:3,cost:800},
  {date:"2025-02-02",line:3,machine:"Palletizer",type:"PM",duration:1,cost:150}
];

/* ------------------ INIT ------------------ */
const tbody=document.querySelector("#rawTable tbody");

function render(){
  tbody.innerHTML="";
  data.forEach((r,i)=>{
    let tr=document.createElement("tr");
    tr.innerHTML=`
      <td><input type="date" value="${r.date}" onchange="update(${i},'date',this.value)"></td>
      <td><input type="number" min="1" max="18" value="${r.line}" onchange="update(${i},'line',this.value)"></td>
      <td><input value="${r.machine}" onchange="update(${i},'machine',this.value)"></td>
      <td>
        <select onchange="update(${i},'type',this.value)">
          <option ${r.type=="Breakdown"?"selected":""}>Breakdown</option>
          <option ${r.type=="PM"?"selected":""}>PM</option>
        </select>
      </td>
      <td><input type="number" value="${r.duration}" onchange="update(${i},'duration',this.value)"></td>
      <td><input type="number" value="${r.cost}" onchange="update(${i},'cost',this.value)"></td>
    `;
    tbody.appendChild(tr);
  });
  recalculate();
}

function update(i,key,val){
  data[i][key]=key=="line"||key=="duration"||key=="cost"?Number(val):val;
  save();
}

function addRow(){
  data.push({date:"2025-01-01",line:1,machine:"Filler",type:"Breakdown",duration:1,cost:100});
  save();
}

function save(){
  localStorage.setItem("maintenanceData",JSON.stringify(data));
  render();
}

/* ------------------ KPI LOGIC ------------------ */
function recalculate(){
  let month=document.getElementById("monthFilter").value;
  let filtered=data.filter(d=>!month||d.date.startsWith(month));

  let breakdowns=filtered.filter(d=>d.type=="Breakdown");
  let pm=filtered.filter(d=>d.type=="PM");

  let bdHours=breakdowns.reduce((a,b)=>a+b.duration,0);
  let cost=filtered.reduce((a,b)=>a+b.cost,0);

  document.getElementById("kpiBreakdown").innerText=bdHours.toFixed(1);
  document.getElementById("kpiPM").innerText=filtered.length?((pm.length/filtered.length)*100).toFixed(0)+"%":"0%";
  document.getElementById("kpiMTTR").innerText=breakdowns.length?(bdHours/breakdowns.length).toFixed(1):0;
  document.getElementById("kpiMTBF").innerText=breakdowns.length?((720/breakdowns.length)).toFixed(1):0;
  document.getElementById("kpiCost").innerText=cost+" SAR";
  document.getElementById("kpiPower").innerText=(cost*0.3).toFixed(0)+" SAR";

  drawChart(filtered);
}

/* ------------------ CHART ------------------ */
function drawChart(filtered){
  const c=document.getElementById("lineChart");
  const ctx=c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);

  let perLine={};
  filtered.forEach(d=>{
    if(d.type=="Breakdown"){
      perLine[d.line]=(perLine[d.line]||0)+d.duration;
    }
  });

  let lines=Object.keys(perLine);
  let max=Math.max(...Object.values(perLine),1);

  lines.forEach((l,i)=>{
    let h=(perLine[l]/max)*200;
    ctx.fillStyle="#1f8f4a";
    ctx.fillRect(30+i*30,220-h,20,h);
    ctx.fillStyle="#000";
    ctx.fillText(l,30+i*30,235);
  });
}

render();
</script>

</body>
</html>

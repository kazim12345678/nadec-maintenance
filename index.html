<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bottling Maintenance Command Center - 2026</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --nadec-blue: #007bbf;
            --nadec-dark: #004a73;
            --bg: #f8f9fa;
            --card-bg: #ffffff;
            --text: #2c3e50;
            --danger: #e74c3c;
            --success: #27ae60;
            --warning: #f39c12;
            --border: #dcdde1;
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', Arial, sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }

        /* --- SIDEBAR --- */
        nav {
            width: 260px;
            background: var(--nadec-dark);
            color: white;
            display: flex;
            flex-direction: column;
            padding: 20px;
            flex-shrink: 0;
        }
        nav h2 { font-size: 1.2rem; margin-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
        nav a { color: rgba(255,255,255,0.7); text-decoration: none; padding: 12px; border-radius: 6px; margin-bottom: 5px; transition: 0.3s; cursor: pointer; }
        nav a:hover, nav a.active { background: var(--nadec-blue); color: white; }
        .sidebar-footer { margin-top: auto; font-size: 0.8rem; opacity: 0.5; }

        /* --- MAIN CONTENT --- */
        main { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; }
        header { 
            background: white; padding: 15px 30px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100;
        }
        .btn-save { background: var(--success); color: white; border: none; padding: 10px 20px; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .btn-reset { background: transparent; color: var(--danger); border: 1px solid var(--danger); padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-right: 10px; }

        /* --- KPI SUMMARY --- */
        .kpi-row { display: grid; grid-template-columns: repeat(6, 1fr); gap: 15px; padding: 20px 30px; }
        .kpi-box { 
            background: white; padding: 20px; border-radius: 8px; border-left: 5px solid var(--nadec-blue); 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); text-align: center;
        }
        .kpi-box h4 { margin: 0; font-size: 0.8rem; color: #7f8c8d; text-transform: uppercase; }
        .kpi-box .val { font-size: 1.5rem; font-weight: bold; color: var(--nadec-dark); margin-top: 5px; }

        /* --- CHART GRID --- */
        .dashboard-view { padding: 0 30px 30px 30px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .chart-card { background: white; padding: 20px; border-radius: 8px; border: 1px solid var(--border); min-height: 350px; }
        .chart-card h3 { margin: 0 0 15px 0; font-size: 1rem; color: var(--nadec-dark); border-bottom: 1px solid #eee; padding-bottom: 8px; }

        /* --- DATA TABLES --- */
        .data-view { padding: 30px; display: none; } /* Hidden by default */
        .table-section { background: white; border-radius: 8px; border: 1px solid var(--border); padding: 20px; margin-bottom: 30px; }
        .table-section h3 { margin-top: 0; }
        .table-container { overflow-x: auto; max-height: 500px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #f1f3f5; padding: 12px; border: 1px solid #dee2e6; text-align: left; position: sticky; top: 0; }
        td { padding: 10px; border: 1px solid #dee2e6; outline: none; }
        td[contenteditable="true"]:focus { background: #fff9c4; border: 2px solid var(--nadec-blue); }
        .calc-field { background: #f8f9fa; font-weight: bold; color: #636e72; }

        /* --- UTILS --- */
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        .badge-danger { background: #ffeaa7; color: #d63031; }

        @media (max-width: 1400px) { .dashboard-view { grid-template-columns: repeat(2, 1fr); } .kpi-row { grid-template-columns: repeat(3, 1fr); } }
    </style>
</head>
<body>

<nav>
    <h2>NADEC Bottling</h2>
    <a onclick="showView('dashboard')" id="nav-dash" class="active">üìä Live Dashboard</a>
    <a onclick="showView('data')" id="nav-data">‚úèÔ∏è Maintenance Logs</a>
    <a onclick="window.print()">üñ®Ô∏è Export Report</a>
    
    <div class="sidebar-footer">
        <p>Asset Management System</p>
        <p>Version 2.4 - 2026</p>
    </div>
</nav>

<main>
    <header>
        <h1 id="view-title">Maintenance Executive Summary</h1>
        <div>
            <button class="btn-reset" onclick="resetData()">Clear Data</button>
            <button class="btn-save" onclick="saveToStorage()">üíæ Save All Changes</button>
        </div>
    </header>

    <!-- TOP KPI CARDS -->
    <div class="kpi-row">
        <div class="kpi-box"><h4>Avg MTBF</h4><div class="val" id="kpi-mtbf">0h</div><small>Reliability</small></div>
        <div class="kpi-box"><h4>Avg MTTR</h4><div class="val" id="kpi-mttr">0m</div><small>Repair Speed</small></div>
        <div class="kpi-box"><h4>Bottles Lost</h4><div class="val" id="kpi-loss">0k</div><small>OEE Impact</small></div>
        <div class="kpi-box"><h4>PM Compliance</h4><div class="val" id="kpi-pm">0%</div><small>Preventive</small></div>
        <div class="kpi-box"><h4>Total Maint Cost</h4><div class="val" id="kpi-cost">$0</div><small>YTD Actual</small></div>
        <div class="kpi-box"><h4>Bad Actor</h4><div class="val" id="kpi-actor">-</div><small>Line Priority</small></div>
    </div>

    <!-- DASHBOARD VIEW -->
    <div id="view-dashboard" class="dashboard-view">
        <div class="chart-card"><h3>Breakdown Pareto (Top 20 Lines)</h3><canvas id="chart-pareto"></canvas></div>
        <div class="chart-card"><h3>Line Health Radar (MTBF vs MTTR)</h3><canvas id="chart-radar"></canvas></div>
        <div class="chart-card"><h3>Loss Impact (Bottles Lost x1000)</h3><canvas id="chart-bottles"></canvas></div>
        <div class="chart-card"><h3>Maintenance Cost (Actual vs Budget)</h3><canvas id="chart-cost"></canvas></div>
        <div class="chart-card"><h3>Root Cause Distribution</h3><canvas id="chart-causes"></canvas></div>
        <div class="chart-card"><h3>Maintenance Manhours (PM vs BM)</h3><canvas id="chart-manhours"></canvas></div>
        <div class="chart-card"><h3>PM Completion Status</h3><canvas id="chart-pm"></canvas></div>
        <div class="chart-card"><h3>Spare Parts Spend Trend</h3><canvas id="chart-spares"></canvas></div>
        <div class="chart-card"><h3>Monthly Failure Trend</h3><canvas id="chart-failure-trend"></canvas></div>
    </div>

    <!-- DATA ENTRY VIEW -->
    <div id="view-data" class="data-view">
        <div class="table-section">
            <h3>1. Bottling Line Master Log (20 Lines)</h3>
            <p><small>Note: Enter Line Speed (Bottles/Hr) to calculate OEE Loss Impact.</small></p>
            <div class="table-container">
                <table id="tbl-main">
                    <thead>
                        <tr>
                            <th>Production Line</th>
                            <th>Status</th>
                            <th>Line Speed (BPH)</th>
                            <th>Downtime (Hrs)</th>
                            <th>Failure Count</th>
                            <th>PM Manhours</th>
                            <th>BM Manhours</th>
                            <th class="calc-field">MTBF (Hrs)</th>
                            <th class="calc-field">MTTR (Min)</th>
                            <th class="calc-field">Loss (k-Bottles)</th>
                        </tr>
                    </thead>
                    <tbody><!-- Generates 20 Lines --></tbody>
                </table>
            </div>
            <button class="btn-save" style="margin-top:15px; background: #34495e;" onclick="addRow('tbl-main')">+ Add Extra Line</button>
        </div>

        <div class="table-section">
            <h3>2. Monthly Finance & Spares</h3>
            <table id="tbl-finance">
                <thead><tr><th>Month</th><th>Maint. Actual ($)</th><th>Budget ($)</th><th>Spare Parts ($)</th><th>Power Cost ($)</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="table-section">
            <h3>3. Root Cause Analysis & PM Status</h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <table id="tbl-causes">
                    <thead><tr><th>Category</th><th>Incidents</th></tr></thead>
                    <tbody>
                        <tr><td>Mechanical</td><td contenteditable="true">45</td></tr>
                        <tr><td>Electrical/Automation</td><td contenteditable="true">32</td></tr>
                        <tr><td>Pneumatic</td><td contenteditable="true">18</td></tr>
                        <tr><td>Operator Error</td><td contenteditable="true">12</td></tr>
                        <tr><td>Lubrication Issue</td><td contenteditable="true">8</td></tr>
                    </tbody>
                </table>
                <table id="tbl-pm-status">
                    <thead><tr><th>PM Status</th><th>Work Orders</th></tr></thead>
                    <tbody>
                        <tr><td>Completed</td><td contenteditable="true">85</td></tr>
                        <tr><td>Scheduled</td><td contenteditable="true">100</td></tr>
                        <tr><td>Overdue</td><td contenteditable="true">15</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<script>
    const MONTHS = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    let charts = {};

    window.onload = () => {
        if (!localStorage.getItem('nadec_bottling_v3')) {
            initDefaults();
        } else {
            loadFromStorage();
        }
        initCharts();
        calculateEverything();
        setupExcelInteractivity();
    };

    function initDefaults() {
        // Build 20 Bottling Lines
        const tbody = document.querySelector('#tbl-main tbody');
        for(let i=1; i<=20; i++) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td contenteditable="true">Bottling Line ${i}</td>
                <td><span class="badge badge-danger">Active</span></td>
                <td contenteditable="true">${18000 + (i*500)}</td>
                <td contenteditable="true">${Math.floor(Math.random()*40) + 5}</td>
                <td contenteditable="true">${Math.floor(Math.random()*10) + 2}</td>
                <td contenteditable="true">${120}</td>
                <td contenteditable="true">${80}</td>
                <td class="calc-field">0</td>
                <td class="calc-field">0</td>
                <td class="calc-field">0</td>
            `;
            tbody.appendChild(tr);
        }

        const finBody = document.querySelector('#tbl-finance tbody');
        MONTHS.forEach(m => {
            finBody.innerHTML += `<tr><td>${m}</td><td contenteditable="true">${5000 + Math.random()*2000}</td><td contenteditable="true">6000</td><td contenteditable="true">${2000}</td><td contenteditable="true">${15000}</td></tr>`;
        });
    }

    function initCharts() {
        const ctx = (id) => document.getElementById(id).getContext('2d');
        const cfg = (type, label, color) => ({
            type: type,
            data: { labels: [], datasets: [{ label: label, data: [], backgroundColor: color, borderColor: color, fill: false }] },
            options: { responsive: true, maintainAspectRatio: false, animation: { duration: 800 } }
        });

        charts.pareto = new Chart(ctx('chart-pareto'), cfg('bar', 'Downtime Hours', '#007bbf'));
        charts.radar = new Chart(ctx('chart-radar'), cfg('radar', 'Line Health', 'rgba(0, 123, 191, 0.2)'));
        charts.bottles = new Chart(ctx('chart-bottles'), cfg('bar', 'k-Bottles Lost', '#e74c3c'));
        charts.cost = new Chart(ctx('chart-cost'), {
            type: 'bar',
            data: { labels: MONTHS, datasets: [{label: 'Actual', backgroundColor: '#004a73'}, {label: 'Budget', backgroundColor: '#ccc'}] },
            options: { responsive: true, maintainAspectRatio: false }
        });
        charts.causes = new Chart(ctx('chart-causes'), cfg('pie', 'Causes', ['#3498db','#9b59b6','#f1c40f','#e67e22','#1abc9c']));
        charts.manhours = new Chart(ctx('chart-manhours'), cfg('doughnut', 'Hrs', ['#27ae60','#e74c3c']));
        charts.pm = new Chart(ctx('chart-pm'), cfg('polarArea', 'Work Orders', ['#27ae60','#3498db','#e74c3c']));
        charts.spares = new Chart(ctx('chart-spares'), cfg('line', 'Spare Parts $', '#8e44ad'));
        charts.failures = new Chart(ctx('chart-failure-trend'), cfg('line', 'Failures', '#c0392b'));
    }

    function calculateEverything() {
        const mainData = getTableData('tbl-main');
        const finData = getTableData('tbl-finance');
        const causeData = getTableData('tbl-causes');
        const pmData = getTableData('tbl-pm-status');

        let totalDowntime = 0;
        let totalFails = 0;
        let totalLoss = 0;
        let totalCost = 0;
        let pmTotal = 0;
        let bmTotal = 0;

        // 1. Process Master Table
        const rows = document.querySelectorAll('#tbl-main tbody tr');
        rows.forEach((tr, i) => {
            const bph = parseFloat(tr.cells[2].innerText) || 0;
            const hrs = parseFloat(tr.cells[3].innerText) || 0;
            const fails = parseFloat(tr.cells[4].innerText) || 0;
            const pmH = parseFloat(tr.cells[5].innerText) || 0;
            const bmH = parseFloat(tr.cells[6].innerText) || 0;

            const mtbf = fails > 0 ? (168 / fails).toFixed(1) : 168; // Based on 1 week
            const mttr = fails > 0 ? ((hrs * 60) / fails).toFixed(0) : 0;
            const loss = (hrs * bph) / 1000;

            tr.cells[7].innerText = mtbf;
            tr.cells[8].innerText = mttr;
            tr.cells[9].innerText = loss.toFixed(0);

            totalDowntime += hrs;
            totalFails += fails;
            totalLoss += loss;
            pmTotal += pmH;
            bmTotal += bmH;
        });

        // 2. Process Finance
        finData.forEach(r => totalCost += parseFloat(r[1]) || 0);

        // 3. Update KPI Cards
        document.getElementById('kpi-mtbf').innerText = totalFails > 0 ? (totalDowntime/totalFails).toFixed(1) + 'h' : '0h';
        document.getElementById('kpi-mttr').innerText = totalFails > 0 ? ((totalDowntime*60)/totalFails).toFixed(0) + 'm' : '0m';
        document.getElementById('kpi-loss').innerText = (totalLoss / 1000).toFixed(1) + 'M';
        document.getElementById('kpi-cost').innerText = '$' + totalCost.toLocaleString();
        
        const comp = parseFloat(pmData[0][1]) || 0;
        const totalPMs = (parseFloat(pmData[0][1])||0) + (parseFloat(pmData[1][1])||0) + (parseFloat(pmData[2][1])||0);
        document.getElementById('kpi-pm').innerText = totalPMs > 0 ? ((comp/totalPMs)*100).toFixed(0) + '%' : '0%';

        // 4. Update Charts
        charts.pareto.data.labels = mainData.map(r => r[0]);
        charts.pareto.data.datasets[0].data = mainData.map(r => r[3]);
        charts.pareto.update();

        charts.bottles.data.labels = mainData.map(r => r[0]);
        charts.bottles.data.datasets[0].data = mainData.map(r => r[9]);
        charts.bottles.update();

        charts.cost.data.datasets[0].data = finData.map(r => r[1]);
        charts.cost.data.datasets[1].data = finData.map(r => r[2]);
        charts.cost.update();

        charts.causes.data.labels = causeData.map(r => r[0]);
        charts.causes.data.datasets[0].data = causeData.map(r => r[1]);
        charts.causes.update();

        charts.manhours.data.labels = ['PM', 'BM'];
        charts.manhours.data.datasets[0].data = [pmTotal, bmTotal];
        charts.manhours.update();

        charts.pm.data.labels = pmData.map(r => r[0]);
        charts.pm.data.datasets[0].data = pmData.map(r => r[1]);
        charts.pm.update();

        charts.spares.data.labels = MONTHS;
        charts.spares.data.datasets[0].data = finData.map(r => r[3]);
        charts.spares.update();
    }

    function getTableData(id) {
        return Array.from(document.querySelectorAll(`#${id} tbody tr`)).map(tr => 
            Array.from(tr.cells).map(td => td.innerText)
        );
    }

    function showView(view) {
        document.getElementById('view-dashboard').style.display = view === 'dashboard' ? 'grid' : 'none';
        document.getElementById('view-data').style.display = view === 'data' ? 'block' : 'none';
        document.getElementById('view-title').innerText = view === 'dashboard' ? 'Maintenance Executive Summary' : 'Maintenance & Breakdown Logs';
        document.getElementById('nav-dash').classList.toggle('active', view === 'dashboard');
        document.getElementById('nav-data').classList.toggle('active', view === 'data');
    }

    function setupExcelInteractivity() {
        document.body.addEventListener('input', (e) => {
            if (e.target.contentEditable) calculateEverything();
        });

        document.body.addEventListener('paste', (e) => {
            if (e.target.contentEditable) {
                e.preventDefault();
                const text = e.clipboardData.getData('text');
                const rows = text.split('\n');
                let curTr = e.target.parentElement;
                const startCol = e.target.cellIndex;
                rows.forEach(rowStr => {
                    if(!rowStr.trim()) return;
                    const cols = rowStr.split('\t');
                    cols.forEach((val, j) => {
                        const cell = curTr.cells[startCol + j];
                        if (cell && cell.contentEditable === "true") cell.innerText = val.trim();
                    });
                    curTr = curTr.nextElementSibling;
                });
                calculateEverything();
            }
        });
    }

    function saveToStorage() {
        const data = {
            main: getTableData('tbl-main'),
            fin: getTableData('tbl-finance'),
            cause: getTableData('tbl-causes'),
            pm: getTableData('tbl-pm-status')
        };
        localStorage.setItem('nadec_bottling_v3', JSON.stringify(data));
        alert('Data Saved to Local Browser Storage!');
    }

    function loadFromStorage() {
        const data = JSON.parse(localStorage.getItem('nadec_bottling_v3'));
        
        const fill = (id, d) => {
            const tbody = document.querySelector(`#${id} tbody`);
            tbody.innerHTML = "";
            d.forEach(rowData => {
                const tr = document.createElement('tr');
                rowData.forEach((val, i) => {
                    const td = document.createElement('td');
                    td.innerText = val;
                    if (id === 'tbl-main' && i >= 7) td.className = 'calc-field';
                    else if (id === 'tbl-finance' && i === 0) td.contentEditable = false;
                    else td.contentEditable = true;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        };

        fill('tbl-main', data.main);
        fill('tbl-finance', data.fin);
        fill('tbl-causes', data.cause);
        fill('tbl-pm-status', data.pm);
    }

    function resetData() {
        if(confirm("Erase all logs?")) {
            localStorage.removeItem('nadec_bottling_v3');
            location.reload();
        }
    }
</script>
</body>
</html>

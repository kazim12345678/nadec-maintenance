<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maintenance KPI Dashboard â€“ 2026 Drinkable Line</title>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --nadec-blue: #007bbf;
            --nadec-dark: #004a73;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f1c40f;
            --bg-gray: #f0f2f5;
            --card-bg: #ffffff;
            --border: #dee2e6;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-gray);
            margin: 0;
            padding: 0;
            color: #333;
        }

        /* Top Header & Toolbar */
        header {
            background-color: var(--nadec-blue);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .toolbar {
            background: #fff;
            padding: 10px 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 10px;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
            font-size: 14px;
        }

        .btn-save { background-color: var(--success); color: white; }
        .btn-reset { background-color: var(--danger); color: white; }
        .btn-add { background-color: var(--nadec-blue); color: white; margin-top: 5px; }
        button:hover { opacity: 0.85; transform: translateY(-1px); }

        /* KPI Card Container */
        .kpi-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            padding: 20px;
        }

        .kpi-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            text-align: center;
            border-top: 4px solid var(--nadec-blue);
        }

        .kpi-card h3 { margin: 0; font-size: 0.85rem; color: #666; text-transform: uppercase; letter-spacing: 0.5px; }
        .kpi-card .value { font-size: 1.8rem; font-weight: 700; margin: 10px 0; color: var(--nadec-blue); }

        /* Chart Section */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            padding: 0 20px 20px 20px;
        }

        @media (max-width: 1200px) { .dashboard-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { .dashboard-grid { grid-template-columns: 1fr; } }

        .chart-box {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            min-height: 320px;
            border: 1px solid var(--border);
        }

        .chart-box h4 { margin: 0 0 15px 0; font-size: 1rem; border-left: 4px solid var(--nadec-blue); padding-left: 10px; }

        /* Table Section */
        .data-section {
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .table-container {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .table-scroll { max-height: 400px; overflow-y: auto; border: 1px solid #eee; }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th {
            background: #f8f9fa;
            position: sticky;
            top: 0;
            padding: 10px;
            border: 1px solid var(--border);
            text-align: left;
            z-index: 5;
        }

        td {
            padding: 8px;
            border: 1px solid var(--border);
            outline: none;
        }

        td[contenteditable="true"]:focus {
            background-color: #fffde7;
            box-shadow: inset 0 0 3px var(--nadec-blue);
        }

        .calc-col { background-color: #fcfcfc; color: #777; font-weight: bold; }

        /* Highlighting for edits */
        .edited { background-color: #fff9c4 !important; }

    </style>
</head>
<body>

<header>
    <h1 style="margin:0; font-size: 1.5rem;">Maintenance KPI Dashboard â€“ 2026 Drinkable Line</h1>
    <span>V1.0 Live Asset Monitoring</span>
</header>

<div class="toolbar">
    <button class="btn-save" onclick="saveToLocalStorage()">ðŸ’¾ SAVE DATA</button>
    <button class="btn-reset" onclick="resetDefaults()">ðŸ”„ RESET DEFAULTS</button>
    <div style="flex-grow: 1;"></div>
    <span style="font-size: 12px; color: #666;">* Edit tables below to update charts instantly. Auto-saves to browser.</span>
</div>

<!-- KPI Cards -->
<div class="kpi-container">
    <div class="kpi-card"><h3>Total Breakdown Hrs</h3><div class="value" id="stat-total-hrs">0</div></div>
    <div class="kpi-card"><h3>Maint. Cost (YTD)</h3><div class="value" id="stat-total-cost">$0</div></div>
    <div class="kpi-card"><h3>PM vs BM Ratio</h3><div class="value" id="stat-pm-ratio">0%</div></div>
    <div class="kpi-card"><h3>Total Failures</h3><div class="value" id="stat-total-fails">0</div></div>
    <div class="kpi-card"><h3>Compliance %</h3><div class="value" id="stat-compliance">0%</div></div>
    <div class="kpi-card"><h3>Top Issue</h3><div class="value" id="stat-top-issue">-</div></div>
</div>

<!-- Charts Grid -->
<div class="dashboard-grid">
    <div class="chart-box"><h4>Breakdown Contribution by Line</h4><canvas id="chart1"></canvas></div>
    <div class="chart-box"><h4>Maintenance Cost (Act vs Bud)</h4><canvas id="chart2"></canvas></div>
    <div class="chart-box"><h4>Work Order Status</h4><canvas id="chart3"></canvas></div>
    <div class="chart-box"><h4>PM vs BM Manhours</h4><canvas id="chart4"></canvas></div>
    <div class="chart-box"><h4>Downtime Root Causes</h4><canvas id="chart5"></canvas></div>
    <div class="chart-box"><h4>Failure Trend (Monthly)</h4><canvas id="chart6"></canvas></div>
    <div class="chart-box"><h4>Breakdown Duration Distribution</h4><canvas id="chart7"></canvas></div>
    <div class="chart-box"><h4>Completion by Frequency</h4><canvas id="chart8"></canvas></div>
    <div class="chart-box"><h4>Power Consumption Cost</h4><canvas id="chart9"></canvas></div>
</div>

<!-- Data Entry Section -->
<div class="data-section">
    <!-- Table 1: 18 Lines -->
    <div class="table-container">
        <h4>1. Breakdown Contribution (18 Lines)</h4>
        <div class="table-scroll">
            <table id="tbl-lines">
                <thead><tr><th>Line Name</th><th>Breakdown Hrs</th><th>% Contrib</th></tr></thead>
                <tbody><!-- Dynamic --></tbody>
            </table>
        </div>
        <button class="btn-add" onclick="addRow('tbl-lines', ['New Line', 0, '0%'])">+ Add Line</button>
    </div>

    <!-- Table 2: Monthly Cost -->
    <div class="table-container">
        <h4>2. Maintenance Cost & Power</h4>
        <div class="table-scroll">
            <table id="tbl-monthly">
                <thead><tr><th>Month</th><th>Maint. Actual</th><th>Maint. Budget</th><th>Power Cost</th></tr></thead>
                <tbody><!-- Dynamic --></tbody>
            </table>
        </div>
    </div>

    <!-- Table 3: Status & Causes -->
    <div class="table-container">
        <h4>3. Order Status & Downtime Causes</h4>
        <div style="display: flex; gap: 10px;">
            <table id="tbl-status">
                <thead><tr><th>Status</th><th>Count</th></tr></thead>
                <tbody>
                    <tr><td>Scheduled</td><td contenteditable="true">40</td></tr>
                    <tr><td>Completed</td><td contenteditable="true">115</td></tr>
                    <tr><td>Overdue</td><td contenteditable="true">12</td></tr>
                </tbody>
            </table>
            <table id="tbl-causes">
                <thead><tr><th>Cause</th><th>%</th></tr></thead>
                <tbody>
                    <tr><td contenteditable="true">Mechanical</td><td contenteditable="true">45</td></tr>
                    <tr><td contenteditable="true">Electrical</td><td contenteditable="true">30</td></tr>
                    <tr><td contenteditable="true">Pneumatic</td><td contenteditable="true">15</td></tr>
                    <tr><td contenteditable="true">Others</td><td contenteditable="true">10</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Table 4: PM/BM & Failures -->
    <div class="table-container">
        <h4>4. PM/BM Manhours & Failures</h4>
        <div class="table-scroll">
            <table id="tbl-pmbm">
                <thead><tr><th>Month</th><th>PM Hrs</th><th>BM Hrs</th><th>Failures</th></tr></thead>
                <tbody><!-- Dynamic --></tbody>
            </table>
        </div>
    </div>

    <!-- Table 5: Frequency & Duration -->
    <div class="table-container">
        <h4>5. Frequency & Duration Analysis</h4>
        <div style="display: flex; gap: 10px;">
            <table id="tbl-freq">
                <thead><tr><th>Frequency</th><th>Sched</th><th>Comp</th></tr></thead>
                <tbody>
                    <tr><td>Weekly</td><td contenteditable="true">50</td><td contenteditable="true">48</td></tr>
                    <tr><td>Monthly</td><td contenteditable="true">20</td><td contenteditable="true">18</td></tr>
                    <tr><td>Yearly</td><td contenteditable="true">5</td><td contenteditable="true">5</td></tr>
                </tbody>
            </table>
            <table id="tbl-duration">
                <thead><tr><th>Bracket</th><th>Actual</th><th>Target</th></tr></thead>
                <tbody>
                    <tr><td>< 1 Hr</td><td contenteditable="true">60</td><td contenteditable="true">70</td></tr>
                    <tr><td>1-2 Hr</td><td contenteditable="true">30</td><td contenteditable="true">25</td></tr>
                    <tr><td>> 2 Hr</td><td contenteditable="true">10</td><td contenteditable="true">5</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const MONTHS = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    let charts = {};

    // Initialize Dashboard
    window.onload = function() {
        if (localStorage.getItem('nadec_kpi_data_v1')) {
            loadFromLocalStorage();
        } else {
            generateDefaults();
        }
        initCharts();
        updateDashboard();
        setupExcelLogic();
    };

    function generateDefaults() {
        // Breakdown Lines (18 lines)
        const lineTbody = document.querySelector('#tbl-lines tbody');
        for (let i = 1; i <= 18; i++) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td contenteditable="true">Line ${i}</td><td contenteditable="true">${Math.floor(Math.random()*50)}</td><td class="calc-col">0%</td>`;
            lineTbody.appendChild(tr);
        }

        // Monthly Data
        const monthlyTbody = document.querySelector('#tbl-monthly tbody');
        const pmbmTbody = document.querySelector('#tbl-pmbm tbody');
        MONTHS.forEach(m => {
            monthlyTbody.innerHTML += `<tr><td>${m}</td><td contenteditable="true">${4000 + Math.floor(Math.random()*1000)}</td><td contenteditable="true">4500</td><td contenteditable="true">${12000 + Math.floor(Math.random()*2000)}</td></tr>`;
            pmbmTbody.innerHTML += `<tr><td>${m}</td><td contenteditable="true">${150 + Math.floor(Math.random()*50)}</td><td contenteditable="true">${80 + Math.floor(Math.random()*40)}</td><td contenteditable="true">${Math.floor(Math.random()*10)}</td></tr>`;
        });
    }

    function initCharts() {
        const config = (type, labels, datasets) => ({
            type: type,
            data: { labels, datasets },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } } }
        });

        charts.c1 = new Chart(document.getElementById('chart1'), config('bar', [], [{ label: 'Hrs', backgroundColor: '#007bbf', data: [] }]));
        charts.c2 = new Chart(document.getElementById('chart2'), config('bar', MONTHS, [{ label: 'Actual', backgroundColor: '#007bbf', data: [] }, { label: 'Budget', backgroundColor: '#ccc', data: [] }]));
        charts.c3 = new Chart(document.getElementById('chart3'), config('doughnut', [], [{ backgroundColor: ['#f1c40f', '#2ecc71', '#e74c3c'], data: [] }]));
        charts.c4 = new Chart(document.getElementById('chart4'), config('bar', MONTHS, [{ label: 'PM Hrs', backgroundColor: '#2ecc71', data: [] }, { label: 'BM Hrs', backgroundColor: '#e74c3c', data: [] }]));
        charts.c5 = new Chart(document.getElementById('chart5'), config('pie', [], [{ backgroundColor: ['#3498db', '#9b59b6', '#e67e22', '#1abc9c'], data: [] }]));
        charts.c6 = new Chart(document.getElementById('chart6'), config('line', MONTHS, [{ label: 'Failures', borderColor: '#e74c3c', data: [], tension: 0.3 }]));
        charts.c7 = new Chart(document.getElementById('chart7'), config('bar', [], [{ label: 'Actual', backgroundColor: '#007bbf', data: [] }, { label: 'Target', backgroundColor: '#eee', data: [] }]));
        charts.c8 = new Chart(document.getElementById('chart8'), config('bar', [], [{ label: 'Sched', backgroundColor: '#34495e', data: [] }, { label: 'Comp', backgroundColor: '#2ecc71', data: [] }]));
        charts.c9 = new Chart(document.getElementById('chart9'), config('bar', MONTHS, [{ label: 'Power Cost', backgroundColor: '#f39c12', data: [] }]));
    }

    function updateDashboard() {
        // Extract data from tables
        const lineData = getTableData('tbl-lines');
        const monthlyData = getTableData('tbl-monthly');
        const statusData = getTableData('tbl-status');
        const pmbmData = getTableData('tbl-pmbm');
        const causeData = getTableData('tbl-causes');
        const freqData = getTableData('tbl-freq');
        const durData = getTableData('tbl-duration');

        // Update KPI Cards
        const totalHrs = lineData.reduce((sum, r) => sum + parseFloat(r[1] || 0), 0);
        const totalCost = monthlyData.reduce((sum, r) => sum + parseFloat(r[1] || 0), 0);
        const totalPM = pmbmData.reduce((sum, r) => sum + parseFloat(r[1] || 0), 0);
        const totalBM = pmbmData.reduce((sum, r) => sum + parseFloat(r[2] || 0), 0);
        const totalFails = pmbmData.reduce((sum, r) => sum + parseFloat(r[3] || 0), 0);
        
        document.getElementById('stat-total-hrs').innerText = totalHrs.toFixed(1);
        document.getElementById('stat-total-cost').innerText = '$' + totalCost.toLocaleString();
        document.getElementById('stat-pm-ratio').innerText = (totalPM + totalBM) > 0 ? ((totalPM / (totalPM + totalBM)) * 100).toFixed(1) + '%' : '0%';
        document.getElementById('stat-total-fails').innerText = totalFails;

        // Update Breakdown Table Percentages
        document.querySelectorAll('#tbl-lines tbody tr').forEach(tr => {
            const val = parseFloat(tr.cells[1].innerText) || 0;
            tr.cells[2].innerText = totalHrs > 0 ? ((val / totalHrs) * 100).toFixed(1) + '%' : '0%';
        });

        // Sync Charts
        charts.c1.data.labels = lineData.map(r => r[0]);
        charts.c1.data.datasets[0].data = lineData.map(r => r[1]);
        charts.c1.update();

        charts.c2.data.datasets[0].data = monthlyData.map(r => r[1]);
        charts.c2.data.datasets[1].data = monthlyData.map(r => r[2]);
        charts.c2.update();

        charts.c3.data.labels = statusData.map(r => r[0]);
        charts.c3.data.datasets[0].data = statusData.map(r => r[1]);
        charts.c3.update();

        charts.c4.data.datasets[0].data = pmbmData.map(r => r[1]);
        charts.c4.data.datasets[1].data = pmbmData.map(r => r[2]);
        charts.c4.update();

        charts.c5.data.labels = causeData.map(r => r[0]);
        charts.c5.data.datasets[0].data = causeData.map(r => r[1]);
        charts.c5.update();

        charts.c6.data.datasets[0].data = pmbmData.map(r => r[3]);
        charts.c6.update();

        charts.c7.data.labels = durData.map(r => r[0]);
        charts.c7.data.datasets[0].data = durData.map(r => r[1]);
        charts.c7.data.datasets[1].data = durData.map(r => r[2]);
        charts.c7.update();

        charts.c8.data.labels = freqData.map(r => r[0]);
        charts.c8.data.datasets[0].data = freqData.map(r => r[1]);
        charts.c8.data.datasets[1].data = freqData.map(r => r[2]);
        charts.c8.update();

        charts.c9.data.datasets[0].data = monthlyData.map(r => r[3]);
        charts.c9.update();
    }

    function getTableData(id) {
        return Array.from(document.querySelectorAll(`#${id} tbody tr`)).map(tr => 
            Array.from(tr.cells).map(td => td.innerText)
        );
    }

    function addRow(tableId, values) {
        const tbody = document.querySelector(`#${tableId} tbody`);
        const tr = document.createElement('tr');
        values.forEach((v, i) => {
            const td = document.createElement('td');
            td.innerText = v;
            if (tableId === 'tbl-lines' && i === 2) td.className = 'calc-col';
            else td.contentEditable = true;
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
        updateDashboard();
    }

    // Excel functionality: Tab, Enter, Copy-Paste
    function setupExcelLogic() {
        document.body.addEventListener('input', (e) => {
            if (e.target.contentEditable) {
                e.target.classList.add('edited');
                updateDashboard();
            }
        });

        document.body.addEventListener('keydown', (e) => {
            if (e.target.contentEditable) {
                const cell = e.target;
                const row = cell.parentElement;
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const nextRow = row.nextElementSibling;
                    if (nextRow) nextRow.cells[cell.cellIndex].focus();
                }
            }
        });

        document.body.addEventListener('paste', (e) => {
            if (e.target.contentEditable) {
                e.preventDefault();
                const text = e.clipboardData.getData('text');
                const rows = text.split('\n');
                let currentTr = e.target.parentElement;
                const startCol = e.target.cellIndex;

                rows.forEach((rowStr, i) => {
                    if (!rowStr) return;
                    const cols = rowStr.split('\t');
                    cols.forEach((val, j) => {
                        if (currentTr && currentTr.cells[startCol + j]) {
                            const target = currentTr.cells[startCol + j];
                            if (target.contentEditable === "true") target.innerText = val.trim();
                        }
                    });
                    currentTr = currentTr.nextElementSibling;
                });
                updateDashboard();
            }
        });
    }

    function saveToLocalStorage() {
        const tables = ['tbl-lines', 'tbl-monthly', 'tbl-status', 'tbl-causes', 'tbl-pmbm', 'tbl-freq', 'tbl-duration'];
        const data = {};
        tables.forEach(t => data[t] = getTableData(t));
        localStorage.setItem('nadec_kpi_data_v1', JSON.stringify(data));
        alert('Data saved successfully to your browser!');
    }

    function loadFromLocalStorage() {
        const data = JSON.parse(localStorage.getItem('nadec_kpi_data_v1'));
        Object.keys(data).forEach(tableId => {
            const tbody = document.querySelector(`#${tableId} tbody`);
            tbody.innerHTML = "";
            data[tableId].forEach(rowValues => {
                const tr = document.createElement('tr');
                rowValues.forEach((v, i) => {
                    const td = document.createElement('td');
                    td.innerText = v;
                    if (tableId === 'tbl-lines' && i === 2) td.className = 'calc-col';
                    else if ( (tableId === 'tbl-monthly' || tableId === 'tbl-pmbm') && i === 0) td.contentEditable = false;
                    else td.contentEditable = true;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        });
    }

    function resetDefaults() {
        if (confirm('Delete all changes and reset to factory defaults?')) {
            localStorage.removeItem('nadec_kpi_data_v1');
            location.reload();
        }
    }
</script>

</body>
</html>
